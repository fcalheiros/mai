#!/bin/bash

# mai.sh - MyAI CLI for Gemini/Gemma API
# Version 0.3

VERSION="0.3"
API_KEY=""
URL=""
OUTPUT_DIR="$HOME/maiout"
CONTENT_TYPE="application/json"

CONFIG_DIR="$HOME/.local/.mai"
CONFIG_FILE="$CONFIG_DIR/mai.conf"
HISTORY_FILE="$CONFIG_DIR/history.ndjson"
HISTORY_GZ="$CONFIG_DIR/history.ndjson.gz"
LOG_FILE="$OUTPUT_DIR/mai.log"
MAX_HISTORY_SIZE=$((10 * 1024 * 1024))  # max size before compression
MAX_MESSAGES=20                          # last messages sent to the model

# Check required dependencies
check_dependencies() {
    if ! command -v jq &> /dev/null || ! command -v curl &> /dev/null; then
        echo "Error: jq and curl are required."
        exit 1
    fi
    if ! command -v gzip &> /dev/null; then
        echo "Error: gzip is required."
        exit 1
    fi
}
check_dependencies

# Create initial config file
create_config() {
    mkdir -p "$CONFIG_DIR"
    echo "Enter your Gemini/Gemma API key:"
    read API_KEY
    echo "Enter the model (e.g., gemini-2.5-flash-lite, gemma-3-27b-it):"
    read MODEL
    URL="https://generativelanguage.googleapis.com/v1beta/models/$MODEL:generateContent"

    {
        echo "API_KEY=$API_KEY"
        echo "URL=$URL"
        echo "OUTPUT_DIR=$HOME/maiout"
    } > "$CONFIG_FILE"

    echo "Config created at $CONFIG_FILE"
}

# Load config values
read_config() {
    while IFS='=' read -r key value; do
        case "$key" in
            API_KEY) API_KEY="$value" ;;
            URL) URL="$value" ;;
           
